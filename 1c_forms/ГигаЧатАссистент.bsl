// Модуль формы "ГигаЧатАссистент"
// Общая форма для интеграции с GigaChat API

// ===========================================
// РЕКВИЗИТЫ ФОРМЫ (создать в конфигураторе):
// - ТекстЗапроса (Строка, неограниченная)
// - СистемныйПромпт (Строка, неограниченная)
// - РезультатHTML (Строка, неограниченная)
// - АдресСервера (Строка), значение по умолчанию: "localhost:8000"
// ===========================================

&НаКлиенте
Процедура ОтправитьЗапрос(Команда)

    Если ПустаяСтрока(ТекстЗапроса) Тогда
        Сообщить("Введите текст для анализа");
        Возврат;
    КонецЕсли;

    // Значение по умолчанию для системного промпта
    ПромптДляОтправки = СистемныйПромпт;
    Если ПустаяСтрока(ПромптДляОтправки) Тогда
        ПромптДляОтправки = "Ты - полезный ассистент. Отвечай кратко и по делу.";
    КонецЕсли;

    // Формируем JSON
    ПараметрыЗапроса = Новый Структура;
    ПараметрыЗапроса.Вставить("text", ТекстЗапроса);
    ПараметрыЗапроса.Вставить("system_prompt", ПромптДляОтправки);
    ПараметрыЗапроса.Вставить("return_format", "html");

    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, ПараметрыЗапроса);
    ТелоЗапроса = ЗаписьJSON.Закрыть();

    // Парсим адрес сервера
    АдресДляПодключения = АдресСервера;
    Если ПустаяСтрока(АдресДляПодключения) Тогда
        АдресДляПодключения = "localhost:8000";
    КонецЕсли;

    АдресЧасти = СтрРазделить(АдресДляПодключения, ":");
    Хост = АдресЧасти[0];
    Если АдресЧасти.Количество() > 1 Тогда
        Порт = Число(АдресЧасти[1]);
    Иначе
        Порт = 8000;
    КонецЕсли;

    // HTTP запрос
    Попытка
        HTTPСоединение = Новый HTTPСоединение(Хост, Порт, , , , 120);
        HTTPЗапрос = Новый HTTPЗапрос("/analyze/text");
        HTTPЗапрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
        HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");

        HTTPОтвет = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);

        Если HTTPОтвет.КодСостояния = 200 Тогда
            ЧтениеJSON = Новый ЧтениеJSON;
            ЧтениеJSON.УстановитьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку());
            Ответ = ПрочитатьJSON(ЧтениеJSON);

            Если Ответ.success Тогда
                РезультатHTML = Ответ.result;
            Иначе
                Сообщить("Ошибка GigaChat: " + Ответ.error);
            КонецЕсли;
        Иначе
            Сообщить("HTTP ошибка: " + HTTPОтвет.КодСостояния);
        КонецЕсли;

    Исключение
        Сообщить("Ошибка подключения: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры

&НаКлиенте
Процедура Очистить(Команда)
    ТекстЗапроса = "";
    РезультатHTML = "";
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьСервер(Команда)

    АдресДляПодключения = АдресСервера;
    Если ПустаяСтрока(АдресДляПодключения) Тогда
        АдресДляПодключения = "localhost:8000";
    КонецЕсли;

    АдресЧасти = СтрРазделить(АдресДляПодключения, ":");
    Хост = АдресЧасти[0];
    Если АдресЧасти.Количество() > 1 Тогда
        Порт = Число(АдресЧасти[1]);
    Иначе
        Порт = 8000;
    КонецЕсли;

    Попытка
        HTTPСоединение = Новый HTTPСоединение(Хост, Порт, , , , 10);
        HTTPЗапрос = Новый HTTPЗапрос("/health");
        HTTPОтвет = HTTPСоединение.Получить(HTTPЗапрос);

        Если HTTPОтвет.КодСостояния = 200 Тогда
            ЧтениеJSON = Новый ЧтениеJSON;
            ЧтениеJSON.УстановитьСтроку(HTTPОтвет.ПолучитьТелоКакСтроку());
            Ответ = ПрочитатьJSON(ЧтениеJSON);

            Если Ответ.status = "ok" Тогда
                Сообщить("Сервер доступен, GigaChat подключен");
            Иначе
                Сообщить("Сервер доступен, но GigaChat недоступен: " + Ответ.error);
            КонецЕсли;
        Иначе
            Сообщить("Сервер вернул код: " + HTTPОтвет.КодСостояния);
        КонецЕсли;

    Исключение
        Сообщить("Сервер недоступен: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры
